Vagrant.configure("2") do |config|
  # Derive the SSH username from the environment (if set) or default to "student"
  ssh_username = ENV["SSH_USERNAME"] || "student"
  ssh_password = ENV["SSH_PASSWORD"] || "student"
  # Construct the user home directory in the container based on the username
  user_home = "/home/#{ssh_username}"
  
  config.vm.provider "docker" do |docker|
    # Build the Docker image from the local directory
    docker.build_dir = "."
    docker.name = "py-sqlit-container"
    
    # Map host ports to container ports:
    # - Host 2222 -> Container 22 (SSH)
    # - Host 8501 -> Container 8501 (Streamlit)
    # - Host 3306 -> Container 3306 (MariaDB)
    docker.ports = ["2222:22", "8501:8501", "3306:3306"]
    docker.remains_running = true

    # Set environment variables for the container, allowing .env or shell
    # environment variables to override defaults.
    docker.env = {
      "GIT_USER_NAME"    => ENV["GIT_USER_NAME"]    || "student_username",
      "GIT_USER_EMAIL"   => ENV["GIT_USER_EMAIL"]   || "student@example.com",
      "STUDENT_HOSTNAME" => ENV["STUDENT_HOSTNAME"] || "std-001",
      "RUN_STREAMLIT"    => ENV["RUN_STREAMLIT"]    || "no",
      "SSH_USERNAME"     => ssh_username,
      "SSH_PASSWORD"     => ssh_password,
      "SSH_KEY_PATH"     => ENV["SSH_KEY_PATH"]     || "#{user_home}/.ssh/id_rsa"
    }

    # Volume mounts:
    # - Mount the current directory to the container at /home/<username>/app (read-write)
    # - Mount the host's ~/.ssh directory into the container (read-only)
    # - Mount a mysql_data folder for persistent database storage
    docker.volumes = [
      "#{File.expand_path('.') }:/home/#{ssh_username}/app:rw",
      "#{ENV['HOME']}/.ssh:#{user_home}/.ssh:ro",
      "./mysql_data:/var/lib/mysql"
    ]
  end

  # A simple shell provisioner that prints out connection instructions.
  config.vm.provision "shell", inline: <<-SHELL
    echo "Container is up and running."
    echo "SSH into the container using:"
    echo "  ssh #{ssh_username}@localhost -p 2222 (Password: #{ssh_password})"
  SHELL
end
